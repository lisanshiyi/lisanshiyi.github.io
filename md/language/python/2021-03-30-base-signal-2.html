<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Signal信号量源码解析 | 李三十一的个人网站</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script>
            var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?c03de854d3cd39bfe134ce906d614b82";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
            })();
            </script>
    <meta name="description" content="李三十一的个人网站，致力于分享和提炼编程技术，让优质丰富的技术信息得到全面可靠的共享，促使信息创造价值。">
    <meta property="article:modified_time" content="2023-01-04T13:17:09.000Z">
    <meta property="og:title" content="Signal信号量源码解析">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/language/python/2021-03-30-base-signal-2.html">
    <meta name="twitter:title" content="Signal信号量源码解析">
    <meta name="twitter:url" content="/md/language/python/2021-03-30-base-signal-2.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="李三十一">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="李三十一，李三十一的个人网站，LiSanShiYi，Python，分布式，数据库，云原生，大数据，算法">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.06e10c60.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1672838731017" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-43.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-5.js?v=1672838731017" as="script"><link rel="preload" href="/assets/js/cg-6.js?v=1672838731017" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.06e10c60.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1672838731017">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">李三十一的个人网站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/about/platform/guide2reading.html" class="nav-link">
  导读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言基础" class="dropdown-title"><span class="title">语言基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/language/python/default.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络技术" class="dropdown-title"><span class="title">网络技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/network/grpc/default.html" class="nav-link">
  gRPC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="存储技术" class="dropdown-title"><span class="title">存储技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/storage/etcd/default.html" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码解析" class="dropdown-title"><span class="title">源码解析</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/sourcecode/requests/default.html" class="nav-link">
  Requests
</a></li><li class="dropdown-item"><!----> <a href="/md/sourcecode/urllib3/default.html" class="nav-link">
  urllib3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他日常" class="dropdown-title"><span class="title">其他日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/other/tools/default.html" class="nav-link">
  工具推荐
</a></li><li class="dropdown-item"><!----> <a href="/md/other/issues/default.html" class="nav-link">
  问题解答
</a></li><li class="dropdown-item"><!----> <a href="/md/other/notes/default.html" class="nav-link">
  随笔日记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/about/me/default.html" class="nav-link">
  关于站长
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/liyaodev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/md/about/platform/default.html" class="nav-link">
  关于小站
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/about/platform/guide2reading.html" class="nav-link">
  导读
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言基础" class="dropdown-title"><span class="title">语言基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/language/python/default.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络技术" class="dropdown-title"><span class="title">网络技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/network/grpc/default.html" class="nav-link">
  gRPC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="存储技术" class="dropdown-title"><span class="title">存储技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/storage/etcd/default.html" class="nav-link">
  etcd
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码解析" class="dropdown-title"><span class="title">源码解析</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/sourcecode/requests/default.html" class="nav-link">
  Requests
</a></li><li class="dropdown-item"><!----> <a href="/md/sourcecode/urllib3/default.html" class="nav-link">
  urllib3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他日常" class="dropdown-title"><span class="title">其他日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/other/tools/default.html" class="nav-link">
  工具推荐
</a></li><li class="dropdown-item"><!----> <a href="/md/other/issues/default.html" class="nav-link">
  问题解答
</a></li><li class="dropdown-item"><!----> <a href="/md/other/notes/default.html" class="nav-link">
  随笔日记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于" class="dropdown-title"><span class="title">关于</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/about/me/default.html" class="nav-link">
  关于站长
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/liyaodev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/md/about/platform/default.html" class="nav-link">
  关于小站
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/language/python/2021-03-30-base-signal-2.html" aria-current="page" class="active sidebar-link">Signal信号量源码解析</a></li><li><a href="/md/language/python/2021-03-02-plugin-technology.html" class="sidebar-link">插件技术基础学习</a></li><li><a href="/md/language/python/2021-03-22-base-==&amp;is.html" class="sidebar-link">==和is的区别解析</a></li><li><a href="/md/language/python/2021-03-25-base-signal-1.html" class="sidebar-link">Signal信号量使用详解</a></li><li><a href="/md/language/python/2021-03-03-base-gil-1.html" class="sidebar-link">GIL基础学习1</a></li><li><a href="/md/language/python/2021-04-15-build-source-code-env-mac.html" class="sidebar-link">Mac搭建Python源码阅读环境</a></li><li><a href="/md/language/python/2021-03-05-base-gil-2.html" class="sidebar-link">GIL基础学习2(可视化)</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h2 id="signals简介"><a href="#signals简介" class="header-anchor">#</a> Signals简介</h2> <p>在类<code>Unix</code>系统上，信号用于将各种信息发送到正在运行的进程，它们来自用户命令，其他进程以及内核本身。所以信号是对已发生事件进程的通知，也可以被描述为软件中断，因为在大多数情况下，它们会中断程序的正常执行流程。</p> <h2 id="linux信号"><a href="#linux信号" class="header-anchor">#</a> Linux信号</h2> <h3 id="信号流转图"><a href="#信号流转图" class="header-anchor">#</a> 信号流转图</h3> <p>信号可以被内核或者进程发出，信号可以在子进程触发但是只能在主进程执行，具体信号流转图如下：</p> <p><img alt="img" data-src="https://lisanshiyi.com/assets/language/python/signal-01.png" loading="lazy" class="lazy"></p> <p>下面我们主要介绍内核发出的信号，具体以下几种情况内核可能会向进程发送信号 [2]：</p> <ul><li>1.When a hardware exception has occurred and that exception needs to be notified to the process. For eg. Attempting division by zero, or referencing the part of memory that is inaccessible.</li> <li>2.Some software event occurred outside the process’s control but effects the process. For instance, input became available on a file descriptor, the terminal window got resized, process’s CPU time limit exceeded, etc.</li> <li>3.User typed some terminal special characters like interrupt(Ctrl+C) or suspend character(Ctrl+Z).</li></ul> <h3 id="信号位表示"><a href="#信号位表示" class="header-anchor">#</a> 信号位表示</h3> <p><code>Linux</code>下可以通过<code>/proc</code>目录来确定进程对信号的处理方式 [3]，下面是一个普通 Python 进程的采样</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">cat</span> /proc/16107/status <span class="token operator">|</span> <span class="token function">grep</span> Sig
SigQ:	<span class="token number">0</span>/257537
SigPnd:	0000000000000000
SigBlk:	0000000000000000
SigIgn:	0000000001001000
SigCgt:	0000000180000002
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>SigQ：number of signals queued/max. number for queue（since 5.12.0）</li> <li>SigPnd：bitmap of pending signals for the thread</li> <li>SigBlk： bitmap of blocked signals</li> <li>SigIgn： bitmap of ignored signals</li> <li>SigCgt：bitmap of caught signals</li></ul> <p>采样值均以十六进制表示，是一个<code>bitmap</code>，总共有 64(4*16) 种信号存在，具体信号表如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">kill</span> <span class="token parameter variable">-l</span>
 <span class="token number">1</span><span class="token punctuation">)</span> SIGHUP	 	<span class="token number">2</span><span class="token punctuation">)</span> SIGINT	 	<span class="token number">3</span><span class="token punctuation">)</span> SIGQUIT	 	<span class="token number">4</span><span class="token punctuation">)</span> SIGILL	 	<span class="token number">5</span><span class="token punctuation">)</span> SIGTRAP
 <span class="token number">6</span><span class="token punctuation">)</span> SIGABRT	 	<span class="token number">7</span><span class="token punctuation">)</span> SIGBUS	 	<span class="token number">8</span><span class="token punctuation">)</span> SIGFPE	 	<span class="token number">9</span><span class="token punctuation">)</span> SIGKILL		<span class="token number">10</span><span class="token punctuation">)</span> SIGUSR1
<span class="token number">11</span><span class="token punctuation">)</span> SIGSEGV		<span class="token number">12</span><span class="token punctuation">)</span> SIGUSR2		<span class="token number">13</span><span class="token punctuation">)</span> SIGPIPE		<span class="token number">14</span><span class="token punctuation">)</span> SIGALRM		<span class="token number">15</span><span class="token punctuation">)</span> SIGTERM
<span class="token number">16</span><span class="token punctuation">)</span> SIGSTKFLT	<span class="token number">17</span><span class="token punctuation">)</span> SIGCHLD		<span class="token number">18</span><span class="token punctuation">)</span> SIGCONT		<span class="token number">19</span><span class="token punctuation">)</span> SIGSTOP		<span class="token number">20</span><span class="token punctuation">)</span> SIGTSTP
<span class="token number">21</span><span class="token punctuation">)</span> SIGTTIN		<span class="token number">22</span><span class="token punctuation">)</span> SIGTTOU		<span class="token number">23</span><span class="token punctuation">)</span> SIGURG		<span class="token number">24</span><span class="token punctuation">)</span> SIGXCPU		<span class="token number">25</span><span class="token punctuation">)</span> SIGXFSZ
<span class="token number">26</span><span class="token punctuation">)</span> SIGVTALRM	<span class="token number">27</span><span class="token punctuation">)</span> SIGPROF		<span class="token number">28</span><span class="token punctuation">)</span> SIGWINCH	<span class="token number">29</span><span class="token punctuation">)</span> SIGIO		<span class="token number">30</span><span class="token punctuation">)</span> SIGPWR
<span class="token number">31</span><span class="token punctuation">)</span> SIGSYS		<span class="token number">34</span><span class="token punctuation">)</span> SIGRTMIN	<span class="token number">35</span><span class="token punctuation">)</span> SIGRTMIN+1	<span class="token number">36</span><span class="token punctuation">)</span> SIGRTMIN+2	<span class="token number">37</span><span class="token punctuation">)</span> SIGRTMIN+3
<span class="token number">38</span><span class="token punctuation">)</span> SIGRTMIN+4	<span class="token number">39</span><span class="token punctuation">)</span> SIGRTMIN+5	<span class="token number">40</span><span class="token punctuation">)</span> SIGRTMIN+6	<span class="token number">41</span><span class="token punctuation">)</span> SIGRTMIN+7	<span class="token number">42</span><span class="token punctuation">)</span> SIGRTMIN+8
<span class="token number">43</span><span class="token punctuation">)</span> SIGRTMIN+9	<span class="token number">44</span><span class="token punctuation">)</span> SIGRTMIN+10	<span class="token number">45</span><span class="token punctuation">)</span> SIGRTMIN+11	<span class="token number">46</span><span class="token punctuation">)</span> SIGRTMIN+12	<span class="token number">47</span><span class="token punctuation">)</span> SIGRTMIN+13
<span class="token number">48</span><span class="token punctuation">)</span> SIGRTMIN+14	<span class="token number">49</span><span class="token punctuation">)</span> SIGRTMIN+15	<span class="token number">50</span><span class="token punctuation">)</span> SIGRTMAX-14	<span class="token number">51</span><span class="token punctuation">)</span> SIGRTMAX-13	<span class="token number">52</span><span class="token punctuation">)</span> SIGRTMAX-12
<span class="token number">53</span><span class="token punctuation">)</span> SIGRTMAX-11	<span class="token number">54</span><span class="token punctuation">)</span> SIGRTMAX-10	<span class="token number">55</span><span class="token punctuation">)</span> SIGRTMAX-9	<span class="token number">56</span><span class="token punctuation">)</span> SIGRTMAX-8	<span class="token number">57</span><span class="token punctuation">)</span> SIGRTMAX-7
<span class="token number">58</span><span class="token punctuation">)</span> SIGRTMAX-6	<span class="token number">59</span><span class="token punctuation">)</span> SIGRTMAX-5	<span class="token number">60</span><span class="token punctuation">)</span> SIGRTMAX-4	<span class="token number">61</span><span class="token punctuation">)</span> SIGRTMAX-3	<span class="token number">62</span><span class="token punctuation">)</span> SIGRTMAX-2
<span class="token number">63</span><span class="token punctuation">)</span> SIGRTMAX-1	<span class="token number">64</span><span class="token punctuation">)</span> SIGRTMAX
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>以上例中的<code>SigCgt</code>为例(转换成二级制后)</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token number">110000000000000000000000000000010</span>
<span class="token operator">||</span>                             <span class="token variable"><span class="token variable">`</span>-<span class="token operator">&gt;</span>	<span class="token assign-left variable">2</span><span class="token operator">=</span>SIGINT
<span class="token operator">|</span><span class="token variable">`</span></span>-------------------------------<span class="token operator">&gt;</span>	<span class="token assign-left variable">32</span><span class="token operator">=</span>SIGRTMIN-2
`--------------------------------<span class="token operator">&gt;</span>	<span class="token assign-left variable">33</span><span class="token operator">=</span>SIGRTMIN-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>SIGINT：连接中断信号，程序终止(interrupt)信号，按下<code>CTRL + C</code>的时候触发。</li> <li><code>SIGRTMIN-1</code>、<code>SIGRTMIN-2</code>：C库为NPTL保留的实时信号；具体查看 <a href="https://man7.org/linux/man-pages/man7/signal.7.html" target="_blank" rel="noopener noreferrer">signal(7)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>假如这会儿我们注册新的信号处理函数<code>signal.signal(signal.SIGHUP, signal.default_int_handler)</code>，那么此时<code>SigCgt</code>的值会变成<code>0000000180000003</code></p> <h2 id="python信号处理机制"><a href="#python信号处理机制" class="header-anchor">#</a> Python信号处理机制</h2> <p>通过上面的学习，是否对<code>Linux</code>信号处理清晰了许多，下面我们将继续介绍<code>Python</code>信号处理源码实现，使用实践可参见之前内容《signal信号量使用详解 | Python基础》</p> <h3 id="代码架构"><a href="#代码架构" class="header-anchor">#</a> 代码架构</h3> <p>大体上，<code>Python</code>解释器对信号的实现总体思路比较简单。</p> <ul><li>解释器负责与操作系统相关信号接口交互</li> <li>解释器实现信号处理接口模块(C)的加载</li> <li>解释器实现<code>signal</code>模块引用信号处理接口模块(C)</li></ul> <p><img alt="signal_python_architecture" data-src="https://lisanshiyi.com/assets/language/python/signal-02.png" loading="lazy" class="lazy"></p> <h3 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h3> <h4 id="信号如何初始化"><a href="#信号如何初始化" class="header-anchor">#</a> 信号如何初始化</h4> <p>下面我们将从信号的初始化开始一点点探索<code>signal</code>模块源码的运作流程，源码来源于 <a href="https://github.com/python/cpython/tree/v3.9.2" target="_blank" rel="noopener noreferrer">python/cpython==v3.9.2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 分支，具体流程图如下：</p> <p><img alt="signal_init_load" data-src="https://lisanshiyi.com/assets/language/python/signal-03.png" loading="lazy" class="lazy"></p> <p>程序入口在<code>Programs/python.c</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Programs<span class="token operator">/</span>python<span class="token punctuation">.</span>c
<span class="token comment">#ifdef MS_WINDOWS</span>
<span class="token builtin">int</span>
wmain<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> wchar_t <span class="token operator">**</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Py_Main<span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token operator">//</span> 启动入口
<span class="token punctuation">}</span>
<span class="token comment">#else</span>
<span class="token builtin">int</span>
main<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> char <span class="token operator">**</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Py_BytesMain<span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">//</span> 启动入口，与Py_Main类似，但argv参数是字节字符串数组
<span class="token punctuation">}</span>
<span class="token comment">#endif</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>启动后可通过<code>Py_Main</code>或<code>Py_BytesMain</code>进入<code>Python</code>环境真正入口<code>pymain_main</code>函数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>main<span class="token punctuation">.</span>c
<span class="token builtin">int</span>
Py_Main<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> wchar_t <span class="token operator">**</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 		<span class="token operator">//</span> 不使用字符参数
    <span class="token keyword">return</span> pymain_main<span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">//</span> 或
<span class="token builtin">int</span>
Py_BytesMain<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> char <span class="token operator">**</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 		<span class="token operator">//</span> 使用字符参数
    <span class="token keyword">return</span> pymain_main<span class="token punctuation">(</span><span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">//</span> 真正入口
static <span class="token builtin">int</span>
pymain_main<span class="token punctuation">(</span>_PyArgv <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyStatus status <span class="token operator">=</span> pymain_init<span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> Python环境加载
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>pymain_init</code>函数实现了信号初始化加载，由于部分函数源码较长，后续只围绕<code>signal</code>相关源码解析</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>main<span class="token punctuation">.</span>c
static PyStatus
pymain_init<span class="token punctuation">(</span>const _PyArgv <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    PyConfig config<span class="token punctuation">;</span>
    PyConfig_InitPythonConfig<span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token operator">//</span> 加载信号量配置参数install_signal_handlers<span class="token operator">=</span><span class="token number">1</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    status <span class="token operator">=</span> Py_InitializeFromConfig<span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 根据配置初始化Python环境
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>Py_InitializeFromConfig</code>函数包含多个调用，<code>pyinit_main</code>函数实现对解释器状态更新功能</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>pylifecycle<span class="token punctuation">.</span>c
PyStatus
Py_InitializeFromConfig<span class="token punctuation">(</span>const PyConfig <span class="token operator">*</span>config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">&gt;</span>_init_main<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 如果_init_main<span class="token operator">==</span><span class="token number">0</span>，在<span class="token string">&quot;main&quot;</span>阶段之前停止初始化
        status <span class="token operator">=</span> pyinit_main<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token operator">//</span> 实现对解释器状态更新功能
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_PyStatus_EXCEPTION<span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在<code>pyinit_main</code>中主要是一个函数调用，即函数<code>init_interp_main</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>pylifecycle<span class="token punctuation">.</span>c
static PyStatus
pyinit_main<span class="token punctuation">(</span>PyThreadState <span class="token operator">*</span>tstate<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    PyStatus status <span class="token operator">=</span> init_interp_main<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>init_interp_main</code>函数包含很多功能初始化，此处只摘取<code>signal</code>相关部分源码</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>pylifecycle<span class="token punctuation">.</span>c
static PyStatus
init_interp_main<span class="token punctuation">(</span>PyThreadState <span class="token operator">*</span>tstate<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_main_interp<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 信号只能运行在主线程上
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_PySignal_Init<span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">&gt;</span>install_signal_handlers<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> _PyStatus_ERR<span class="token punctuation">(</span><span class="token string">&quot;can't initialize signals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>_PySignal_Init</code>调用<code>signal_install_handlers</code>函数触发了信号量加载，此处还可以发现之前加载的<code>install_signal_handlers=1</code>参数实际为信号量加载开关</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
<span class="token builtin">int</span>
_PySignal_Init<span class="token punctuation">(</span><span class="token builtin">int</span> install_signal_handlers<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>install_signal_handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signal_install_handlers<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>signal_install_handlers</code>具体实现如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static <span class="token builtin">int</span>
signal_install_handlers<span class="token punctuation">(</span>void<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment">#ifdef SIGPIPE</span>
    PyOS_setsig<span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token operator">//</span> 忽略SIGPIPE信号
<span class="token comment">#endif</span>
<span class="token comment">#ifdef SIGXFZ</span>
    PyOS_setsig<span class="token punctuation">(</span>SIGXFZ<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token operator">//</span> 忽略SIGPIPE信号
<span class="token comment">#endif</span>
<span class="token comment">#ifdef SIGXFSZ</span>
    PyOS_setsig<span class="token punctuation">(</span>SIGXFSZ<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token operator">//</span> 忽略SIGPIPE信号
<span class="token comment">#endif</span>

    <span class="token operator">//</span> Import _signal to install the Python SIGINT handler
    PyObject <span class="token operator">*</span>module <span class="token operator">=</span> PyImport_ImportModule<span class="token punctuation">(</span><span class="token string">&quot;_signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 导入信号模块，此处触发Python信号的加载逻辑
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Py_DECREF<span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>PyOS_setsig</code>是对<code>OS</code>层信号量的封装，这块代码也可以解释为什么本文起始<code>Linux</code>示例中<code>SigIgn</code>为什么是<code>0x0000000001001000</code></p> <ul><li><code>SIGPIPE</code>：当进程试图写入数据到管道、<code>FIFO</code>、<code>Socket</code>，但却没有相应的读取进程，会触发这个信号。通常是由于读取进程关闭了<code>IPC</code>通道的文件描述符而产生</li> <li><code>SIGXFZ</code>：这个没找到具体用途，尴尬脸<code>TODO</code></li> <li><code>SIGXFSZ</code>：当进程试图使用<code>write()</code>或<code>truncate()</code>函数，但却超出了进程的文件大小资源限制<code>RLIMIT_FSIZE</code>产生</li></ul> <p><code>signal_install_handlers</code>通过<code>PyImport_ImportModule</code>导入了<code>_signal</code>信号模块，该结构体具体实现如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static struct PyModuleDef signalmodule <span class="token operator">=</span> <span class="token punctuation">{</span>
    PyModuleDef_HEAD_INIT<span class="token punctuation">,</span>
    <span class="token string">&quot;_signal&quot;</span><span class="token punctuation">,</span>		<span class="token operator">//</span> 模块名字，<span class="token keyword">import</span>命令使用到
    module_doc<span class="token punctuation">,</span>		<span class="token operator">//</span> 模块的说明，XXX<span class="token punctuation">.</span>__doc__ 将输出的内容
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    signal_methods<span class="token punctuation">,</span>	<span class="token operator">//</span> 模块中定义的函数列表
    NULL<span class="token punctuation">,</span>
    NULL<span class="token punctuation">,</span>
    NULL<span class="token punctuation">,</span>
    NULL
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="怎样加载信号"><a href="#怎样加载信号" class="header-anchor">#</a> 怎样加载信号</h4> <p>接下来我们看看信号模块加载实现，信号的加载入口为<code>PyInit__signal</code>函数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
PyMODINIT_FUNC
PyInit__signal<span class="token punctuation">(</span>void<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyObject <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token operator">*</span>d<span class="token punctuation">;</span>
    <span class="token builtin">int</span> i<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> Create the module <span class="token keyword">and</span> add the functions <span class="token operator">*</span><span class="token operator">/</span>
    m <span class="token operator">=</span> PyModule_Create<span class="token punctuation">(</span><span class="token operator">&amp;</span>signalmodule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>

<span class="token comment">#if defined(HAVE_SIGWAITINFO) || defined(HAVE_SIGTIMEDWAIT)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PyStructSequence_InitType2<span class="token punctuation">(</span><span class="token operator">&amp;</span>SiginfoType<span class="token punctuation">,</span> <span class="token operator">&amp;</span>struct_siginfo_desc<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Py_INCREF<span class="token punctuation">(</span><span class="token punctuation">(</span>PyObject<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>SiginfoType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PyModule_AddObject<span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">&quot;struct_siginfo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>SiginfoType<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 构建 PyModule_GetDict 执行结构体
    initialized <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>

    <span class="token operator">/</span><span class="token operator">*</span> Add some symbolic constants to the module <span class="token operator">*</span><span class="token operator">/</span>
    d <span class="token operator">=</span> PyModule_GetDict<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 获取 PyModuleObject 变量

	<span class="token operator">//</span> 校验默认处理类型信号并分配默认处理的执行函数
    DefaultHandler <span class="token operator">=</span> PyLong_FromVoidPtr<span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span>SIG_DFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!DefaultHandler <span class="token operator">|</span><span class="token operator">|</span>
        PyDict_SetItemString<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">&quot;SIG_DFL&quot;</span><span class="token punctuation">,</span> DefaultHandler<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        goto <span class="token keyword">finally</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 失败
    <span class="token punctuation">}</span>
	<span class="token operator">//</span> 校验忽略处理类型信号并分配忽略处理的执行函数
    IgnoreHandler <span class="token operator">=</span> PyLong_FromVoidPtr<span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!IgnoreHandler <span class="token operator">|</span><span class="token operator">|</span>
        PyDict_SetItemString<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">&quot;SIG_IGN&quot;</span><span class="token punctuation">,</span> IgnoreHandler<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token operator">//</span> 校验自定义处理类型信号并分配自定义处理的执行函数
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> NSIG<span class="token punctuation">)</span><span class="token punctuation">)</span>
        goto <span class="token keyword">finally</span><span class="token punctuation">;</span>

<span class="token comment">#ifdef SIG_BLOCK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> SIG_BLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token operator">//</span> 在原有掩码上添加pSet
         goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
<span class="token comment">#ifdef SIG_UNBLOCK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> SIG_UNBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token operator">//</span> 在原有源码上去除pSet
         goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
<span class="token comment">#ifdef SIG_SETMASK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> SIG_SETMASK<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token operator">//</span> 设置掩码为pSet
         goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
	<span class="token operator">//</span> 获取signal模块中的默认处理函数，实际就是 signal_default_int_handler 
    IntHandler <span class="token operator">=</span> PyDict_GetItemString<span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">&quot;default_int_handler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!IntHandler<span class="token punctuation">)</span>
        goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
    Py_INCREF<span class="token punctuation">(</span>IntHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>Handlers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tripped<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 
    <span class="token operator">//</span> 循环初始化每个信号的Handlers，这个数组存储每个用户自定义的信号处理函数，以及标志是否发生该信号的标志
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NSIG<span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        void <span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t <span class="token operator">=</span> PyOS_getsig<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>Handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tripped<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> SIG_DFL<span class="token punctuation">)</span>
            Handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">=</span> DefaultHandler<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> SIG_IGN<span class="token punctuation">)</span>
            Handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">=</span> IgnoreHandler<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            Handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">=</span> Py_None<span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">*</span> <span class="token boolean">None</span> of our business <span class="token operator">*</span><span class="token operator">/</span>
        Py_INCREF<span class="token punctuation">(</span>Handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">//</span> 为 SIGINT 设置Python解释器的信号处理函数signal_handler
    <span class="token operator">//</span> signal_handler 也会成为Python解释器与用户自定义处理函数的桥梁
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Handlers<span class="token punctuation">[</span>SIGINT<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">==</span> DefaultHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span><span class="token operator">*</span> Install default <span class="token builtin">int</span> handler <span class="token operator">*</span><span class="token operator">/</span>
        Py_INCREF<span class="token punctuation">(</span>IntHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Py_SETREF<span class="token punctuation">(</span>Handlers<span class="token punctuation">[</span>SIGINT<span class="token punctuation">]</span><span class="token punctuation">.</span>func<span class="token punctuation">,</span> IntHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        PyOS_setsig<span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">//</span> 添加 signal<span class="token punctuation">.</span>SIGHUP 的定义<span class="token punctuation">(</span>信号值和名称<span class="token punctuation">)</span>
<span class="token comment">#ifdef SIGHUP</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">)</span><span class="token punctuation">)</span>
         goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
<span class="token comment">#ifdef SIGINT</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyModule_AddIntMacro<span class="token punctuation">(</span>m<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">)</span>
         goto <span class="token keyword">finally</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
	<span class="token operator">//</span> 添加 signal 模块中的各个 SIGXXX 的定义
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	以此类推，这里不一一阐述
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyErr_Occurred<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Py_DECREF<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> m<span class="token punctuation">;</span>	<span class="token operator">//</span> PyImport_ImportModule<span class="token punctuation">(</span><span class="token string">&quot;_signal&quot;</span><span class="token punctuation">)</span>方法取到的信号变量就是m
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><p><code>signal_methods</code>的定义了模块中的函数列表，<code>default_int_handler</code>定义了默认执行函数，默认抛出<code>KeyboardInterrupt</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static PyObject <span class="token operator">*</span>
signal_default_int_handler<span class="token punctuation">(</span>PyObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyErr_SetNone<span class="token punctuation">(</span>PyExc_KeyboardInterrupt<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token operator">//</span> 抛出 KeyboardInterrupt
    <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>Handlers</code>是一个结构体数组，由信号的标志<code>tripped</code>和信号自定义处理函数<code>func</code>组成，具体结构如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static volatile struct <span class="token punctuation">{</span>
    _Py_atomic_int tripped<span class="token punctuation">;</span>
    PyObject <span class="token operator">*</span>func<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Handlers<span class="token punctuation">[</span>NSIG<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="信号函数实现"><a href="#信号函数实现" class="header-anchor">#</a> 信号函数实现</h4> <p>我们先看一下<code>Python</code>中用于注册信号处理函数的<code>signal.signal</code>的实现</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>static PyObject <span class="token operator">*</span>
signal_signal_impl<span class="token punctuation">(</span>PyObject <span class="token operator">*</span>module<span class="token punctuation">,</span> <span class="token builtin">int</span> signalnum<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>handler<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PyObject <span class="token operator">*</span>old_handler<span class="token punctuation">;</span>
    void <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#ifdef MS_WINDOWS</span>
    <span class="token operator">/</span><span class="token operator">*</span> Validate that signalnum <span class="token keyword">is</span> one of the allowable signals <span class="token operator">*</span><span class="token operator">/</span>
    switch <span class="token punctuation">(</span>signalnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 校验不被系统允许的信号
        <span class="token keyword">case</span> SIGABRT<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment">#ifdef SIGBREAK</span>
        <span class="token operator">/</span><span class="token operator">*</span> Issue <span class="token comment">#10003: SIGBREAK is not documented as permitted, but works</span>
           <span class="token keyword">and</span> corresponds to CTRL_BREAK_EVENT<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">case</span> SIGBREAK<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
        <span class="token keyword">case</span> SIGFPE<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SIGILL<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SIGINT<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SIGSEGV<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SIGTERM<span class="token punctuation">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        default<span class="token punctuation">:</span>
            PyErr_SetString<span class="token punctuation">(</span>PyExc_ValueError<span class="token punctuation">,</span> <span class="token string">&quot;invalid signal value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">#endif</span>
	<span class="token operator">//</span> 检测当前是否为主线程，这样解释为啥信号设置只能在主线程
    PyThreadState <span class="token operator">*</span>tstate <span class="token operator">=</span> _PyThreadState_GET<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!_Py_ThreadCanHandleSignals<span class="token punctuation">(</span>tstate<span class="token operator">-</span><span class="token operator">&gt;</span>interp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _PyErr_SetString<span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_ValueError<span class="token punctuation">,</span>
                         <span class="token string">&quot;signal only works in main thread &quot;</span>
                         <span class="token string">&quot;of the main interpreter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">//</span> 信号值越界检测
    <span class="token keyword">if</span> <span class="token punctuation">(</span>signalnum <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span> signalnum <span class="token operator">&gt;=</span> NSIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _PyErr_SetString<span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_ValueError<span class="token punctuation">,</span>
                         <span class="token string">&quot;signal number out of range&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> IgnoreHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>			<span class="token operator">//</span> 忽略执行函数定义
        func <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> DefaultHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 默认执行函数定义
        func <span class="token operator">=</span> SIG_DFL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>!PyCallable_Check<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 验证自定义执行函数是否可被调用
        _PyErr_SetString<span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_TypeError<span class="token punctuation">,</span>
                         <span class="token string">&quot;signal handler must be signal.SIG_IGN, &quot;</span>
                         <span class="token string">&quot;signal.SIG_DFL, or a callable object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>				<span class="token operator">//</span> 自定义执行函数定义
        func <span class="token operator">=</span> signal_handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_PyErr_CheckSignalsTstate<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 在更改信号处理程序之前检查挂起信号标志位`is_tripped`，为<span class="token number">1</span>需重新调度，为<span class="token number">0</span>可以继续往下执行
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PyOS_setsig<span class="token punctuation">(</span>signalnum<span class="token punctuation">,</span> func<span class="token punctuation">)</span> <span class="token operator">==</span> SIG_ERR<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 假如信号处理程序设置失败
        PyErr_SetFromErrno<span class="token punctuation">(</span>PyExc_OSError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    old_handler <span class="token operator">=</span> Handlers<span class="token punctuation">[</span>signalnum<span class="token punctuation">]</span><span class="token punctuation">.</span>func<span class="token punctuation">;</span>
    Py_INCREF<span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Handlers<span class="token punctuation">[</span>signalnum<span class="token punctuation">]</span><span class="token punctuation">.</span>func <span class="token operator">=</span> handler<span class="token punctuation">;</span>		<span class="token operator">//</span> 记录自定义的函数到Handlers数组中

    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_handler <span class="token operator">!=</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 如果存在则返回老的执行函数
        <span class="token keyword">return</span> old_handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Py_RETURN_NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>通常我们会自定义执行函数，具体如<code>signal_handler</code></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static void
signal_handler<span class="token punctuation">(</span><span class="token builtin">int</span> sig_num<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token builtin">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>

    trip_signal<span class="token punctuation">(</span>sig_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>signal_handler</code>里面的核心逻辑是触发<code>trip_signal</code>函数</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Modules<span class="token operator">/</span>signalmodule<span class="token punctuation">.</span>c
static void
trip_signal<span class="token punctuation">(</span><span class="token builtin">int</span> sig_num<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    unsigned char byte<span class="token punctuation">;</span>
    <span class="token builtin">int</span> fd<span class="token punctuation">;</span>
    Py_ssize_t rc<span class="token punctuation">;</span>
	<span class="token operator">//</span> 设置对应信号标志位置状态为<span class="token number">1</span>
    _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>Handlers<span class="token punctuation">[</span>sig_num<span class="token punctuation">]</span><span class="token punctuation">.</span>tripped<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> Set is_tripped after setting <span class="token punctuation">.</span>tripped<span class="token punctuation">,</span> <span class="token keyword">as</span> it gets
       cleared <span class="token keyword">in</span> PyErr_CheckSignals<span class="token punctuation">(</span><span class="token punctuation">)</span> before <span class="token punctuation">.</span>tripped<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
    _Py_atomic_store<span class="token punctuation">(</span><span class="token operator">&amp;</span>is_tripped<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token operator">//</span> 挂起信号标志位 is_tripped

    <span class="token operator">/</span><span class="token operator">*</span> Signals are always handled by the main interpreter <span class="token operator">*</span><span class="token operator">/</span>
    PyInterpreterState <span class="token operator">*</span>interp <span class="token operator">=</span> _PyRuntime<span class="token punctuation">.</span>interpreters<span class="token punctuation">.</span>main<span class="token punctuation">;</span>

    <span class="token operator">//</span> 发送消息给解释器即可，这个为核心函数下面细讲
    _PyEval_SignalReceived<span class="token punctuation">(</span>interp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="解释器处理逻辑"><a href="#解释器处理逻辑" class="header-anchor">#</a> 解释器处理逻辑</h4> <p>解释器执行信息核心部分位于<code>_PyEval_SignalReceived</code>，<code>wakeup_fd</code>默认为<code>INVALID_FD</code>，用户可以通过<code>Python</code>接口函数<code>signal.set_wakeup_fd</code>对其进行设置</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
void
_PyEval_SignalReceived<span class="token punctuation">(</span>PyInterpreterState <span class="token operator">*</span>interp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment">#ifdef MS_WINDOWS</span>
    <span class="token operator">//</span> bpo<span class="token operator">-</span><span class="token number">42296</span><span class="token punctuation">:</span> On Windows<span class="token punctuation">,</span> _PyEval_SignalReceived<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> called <span class="token keyword">from</span> a signal
    <span class="token operator">//</span> handler which can run <span class="token keyword">in</span> a thread different than the Python thread<span class="token punctuation">,</span> <span class="token keyword">in</span>
    <span class="token operator">//</span> which <span class="token keyword">case</span> _Py_ThreadCanHandleSignals<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> wrong<span class="token punctuation">.</span> Ignore
    <span class="token operator">//</span> _Py_ThreadCanHandleSignals<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> always <span class="token builtin">set</span> eval_breaker to <span class="token number">1.</span>
    <span class="token operator">//</span>
    <span class="token operator">//</span> The <span class="token builtin">next</span> eval_frame_handle_pending<span class="token punctuation">(</span><span class="token punctuation">)</span> call will call
    <span class="token operator">//</span> _Py_ThreadCanHandleSignals<span class="token punctuation">(</span><span class="token punctuation">)</span> to recompute eval_breaker<span class="token punctuation">.</span>
    <span class="token builtin">int</span> force <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">#else</span>
    <span class="token builtin">int</span> force <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">#endif</span>
    <span class="token operator">/</span><span class="token operator">*</span> bpo<span class="token operator">-</span><span class="token number">30703</span><span class="token punctuation">:</span> Function called when the C signal handler of Python gets a
       signal<span class="token punctuation">.</span> We cannot queue a callback using _PyEval_AddPendingCall<span class="token punctuation">(</span><span class="token punctuation">)</span> since
       that function <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">async</span><span class="token operator">-</span>signal<span class="token operator">-</span>safe<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
    SIGNAL_PENDING_SIGNALS<span class="token punctuation">(</span>interp<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
static inline void
SIGNAL_PENDING_SIGNALS<span class="token punctuation">(</span>PyInterpreterState <span class="token operator">*</span>interp<span class="token punctuation">,</span> <span class="token builtin">int</span> force<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct _ceval_runtime_state <span class="token operator">*</span>ceval <span class="token operator">=</span> <span class="token operator">&amp;</span>interp<span class="token operator">-</span><span class="token operator">&gt;</span>runtime<span class="token operator">-</span><span class="token operator">&gt;</span>ceval<span class="token punctuation">;</span>
    struct _ceval_state <span class="token operator">*</span>ceval2 <span class="token operator">=</span> <span class="token operator">&amp;</span>interp<span class="token operator">-</span><span class="token operator">&gt;</span>ceval<span class="token punctuation">;</span>
    _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval<span class="token operator">-</span><span class="token operator">&gt;</span>signals_pending<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>eval_breaker<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span><span class="token operator">*</span> eval_breaker <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token builtin">set</span> to <span class="token number">1</span> <span class="token keyword">if</span> thread_can_handle_signals<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> false <span class="token operator">*</span><span class="token operator">/</span>
        COMPUTE_EVAL_BREAKER<span class="token punctuation">(</span>interp<span class="token punctuation">,</span> ceval<span class="token punctuation">,</span> ceval2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
<span class="token operator">/</span><span class="token operator">*</span> This can <span class="token builtin">set</span> eval_breaker to <span class="token number">0</span> even though gil_drop_request became
   <span class="token number">1.</span>  We believe this <span class="token keyword">is</span> <span class="token builtin">all</span> right because the <span class="token builtin">eval</span> loop will release
   the GIL eventually anyway<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
static inline void
COMPUTE_EVAL_BREAKER<span class="token punctuation">(</span>PyInterpreterState <span class="token operator">*</span>interp<span class="token punctuation">,</span>
                     struct _ceval_runtime_state <span class="token operator">*</span>ceval<span class="token punctuation">,</span>
                     struct _ceval_state <span class="token operator">*</span>ceval2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _Py_atomic_store_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>eval_breaker<span class="token punctuation">,</span>
        _Py_atomic_load_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>gil_drop_request<span class="token punctuation">)</span>
        <span class="token operator">|</span> <span class="token punctuation">(</span>_Py_atomic_load_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval<span class="token operator">-</span><span class="token operator">&gt;</span>signals_pending<span class="token punctuation">)</span>
           <span class="token operator">&amp;</span><span class="token operator">&amp;</span> _Py_ThreadCanHandleSignals<span class="token punctuation">(</span>interp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">|</span> <span class="token punctuation">(</span>_Py_atomic_load_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>pending<span class="token punctuation">.</span>calls_to_do<span class="token punctuation">)</span>
           <span class="token operator">&amp;</span><span class="token operator">&amp;</span> _Py_ThreadCanHandlePendingCalls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">|</span> ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>pending<span class="token punctuation">.</span>async_exc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这一系列的操作最终影响下一次解释器循环，那解释器具体怎么处理呢？<code>_PyEval_EvalFrameDefault</code>为解释器的核心函数，主要做循环处理执行命令操作（<code>3.9.2</code>版本的<code>_PyEval_EvalFrameDefault</code>优化后流程比较复杂，后续单独抽一篇详细拆解）</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
PyObject<span class="token operator">*</span> _Py_HOT_FUNCTION
_PyEval_EvalFrameDefault<span class="token punctuation">(</span>PyThreadState <span class="token operator">*</span>tstate<span class="token punctuation">,</span> PyFrameObject <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token builtin">int</span> throwflag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
main_loop<span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>stack_pointer <span class="token operator">&gt;=</span> f<span class="token operator">-</span><span class="token operator">&gt;</span>f_valuestack<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">*</span> <span class="token keyword">else</span> underflow <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>STACK_LEVEL<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> co<span class="token operator">-</span><span class="token operator">&gt;</span>co_stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">/</span><span class="token operator">*</span> <span class="token keyword">else</span> overflow <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>!_PyErr_Occurred<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">/</span><span class="token operator">*</span> Do periodic things<span class="token punctuation">.</span>  Doing this every time through
           the loop would add too much overhead<span class="token punctuation">,</span> so we do it
           only every Nth instruction<span class="token punctuation">.</span>  We also do it <span class="token keyword">if</span>
           ``pending<span class="token punctuation">.</span>calls_to_do<span class="token string">''</span> <span class="token keyword">is</span> <span class="token builtin">set</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> when an asynchronous
           event needs attention <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> a signal handler <span class="token keyword">or</span>
           <span class="token keyword">async</span> I<span class="token operator">/</span>O handler<span class="token punctuation">)</span><span class="token punctuation">;</span> see Py_AddPendingCall<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span>
           Py_MakePendingCalls<span class="token punctuation">(</span><span class="token punctuation">)</span> above<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_Py_atomic_load_relaxed<span class="token punctuation">(</span>eval_breaker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eval_frame_handle_pending<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 解释器处理信号
                goto error<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    fast_next_opcode<span class="token punctuation">:</span>
<span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>解释器设计信号部分主要在<code>eval_frame_handle_pending</code>函数里面完成</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
<span class="token operator">/</span><span class="token operator">*</span> Handle signals<span class="token punctuation">,</span> pending calls<span class="token punctuation">,</span> GIL drop request
   <span class="token keyword">and</span> asynchronous exception <span class="token operator">*</span><span class="token operator">/</span>
static <span class="token builtin">int</span>
eval_frame_handle_pending<span class="token punctuation">(</span>PyThreadState <span class="token operator">*</span>tstate<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _PyRuntimeState <span class="token operator">*</span> const runtime <span class="token operator">=</span> <span class="token operator">&amp;</span>_PyRuntime<span class="token punctuation">;</span>
    struct _ceval_runtime_state <span class="token operator">*</span>ceval <span class="token operator">=</span> <span class="token operator">&amp;</span>runtime<span class="token operator">-</span><span class="token operator">&gt;</span>ceval<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> Pending signals <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_Py_atomic_load_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval<span class="token operator">-</span><span class="token operator">&gt;</span>signals_pending<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token operator">//</span> 处理信号状态
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle_signals<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span><span class="token operator">*</span> Pending calls <span class="token operator">*</span><span class="token operator">/</span>
    struct _ceval_state <span class="token operator">*</span>ceval2 <span class="token operator">=</span> <span class="token operator">&amp;</span>tstate<span class="token operator">-</span><span class="token operator">&gt;</span>interp<span class="token operator">-</span><span class="token operator">&gt;</span>ceval<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_Py_atomic_load_relaxed<span class="token punctuation">(</span><span class="token operator">&amp;</span>ceval2<span class="token operator">-</span><span class="token operator">&gt;</span>pending<span class="token punctuation">.</span>calls_to_do<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">//</span> 处理回调
        <span class="token keyword">if</span> <span class="token punctuation">(</span>make_pending_calls<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">//</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>make_pending_calls</code>函数为具体的信号处理逻辑</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Python<span class="token operator">/</span>ceval<span class="token punctuation">.</span>c
static <span class="token builtin">int</span>
make_pending_calls<span class="token punctuation">(</span>PyThreadState <span class="token operator">*</span>tstate<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>is_tstate_valid<span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> only execute pending calls on main thread <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>!_Py_ThreadCanHandlePendingCalls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span><span class="token operator">*</span> don't perform recursive pending calls <span class="token operator">*</span><span class="token operator">/</span>
    static <span class="token builtin">int</span> busy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>busy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    busy <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> unsignal before starting to call callbacks<span class="token punctuation">,</span> so that <span class="token builtin">any</span> callback
       added <span class="token keyword">in</span><span class="token operator">-</span>between re<span class="token operator">-</span>signals <span class="token operator">*</span><span class="token operator">/</span>
    UNSIGNAL_PENDING_CALLS<span class="token punctuation">(</span>tstate<span class="token operator">-</span><span class="token operator">&gt;</span>interp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span> perform a bounded number of calls<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">case</span> of recursion <span class="token operator">*</span><span class="token operator">/</span>
    struct _pending_calls <span class="token operator">*</span>pending <span class="token operator">=</span> <span class="token operator">&amp;</span>tstate<span class="token operator">-</span><span class="token operator">&gt;</span>interp<span class="token operator">-</span><span class="token operator">&gt;</span>ceval<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NPENDINGCALLS<span class="token punctuation">;</span> i<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> NULL<span class="token punctuation">;</span>
        void <span class="token operator">*</span>arg <span class="token operator">=</span> NULL<span class="token punctuation">;</span>

        <span class="token operator">/</span><span class="token operator">*</span> pop one item off the queue <span class="token keyword">while</span> holding the lock <span class="token operator">*</span><span class="token operator">/</span>
        PyThread_acquire_lock<span class="token punctuation">(</span>pending<span class="token operator">-</span><span class="token operator">&gt;</span>lock<span class="token punctuation">,</span> WAIT_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pop_pending_call<span class="token punctuation">(</span>pending<span class="token punctuation">,</span> <span class="token operator">&amp;</span>func<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        PyThread_release_lock<span class="token punctuation">(</span>pending<span class="token operator">-</span><span class="token operator">&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">/</span><span class="token operator">*</span> having released the lock<span class="token punctuation">,</span> perform the callback <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>func <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        res <span class="token operator">=</span> func<span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            goto error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    busy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>

error<span class="token punctuation">:</span>
    busy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    SIGNAL_PENDING_CALLS<span class="token punctuation">(</span>tstate<span class="token operator">-</span><span class="token operator">&gt;</span>interp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><code>Python</code>中维持了一个<code>_pending_calls</code>数组，可以将<code>ceval.c</code>文件里解释器循环流程<code>for (;;))</code>中调用的函数放在里面，具体结构如下</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">//</span> Include<span class="token operator">/</span>internal<span class="token operator">/</span>pycore_interp<span class="token punctuation">.</span>h
struct _pending_calls <span class="token punctuation">{</span>
    PyThread_type_lock lock<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span> Request <span class="token keyword">for</span> running pending calls<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
    _Py_atomic_int calls_to_do<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span> Request <span class="token keyword">for</span> looking at the `async_exc` field of the current
       thread state<span class="token punctuation">.</span>
       Guarded by the GIL<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token builtin">int</span> async_exc<span class="token punctuation">;</span>
<span class="token comment">#define NPENDINGCALLS 32</span>
    struct <span class="token punctuation">{</span>
        <span class="token builtin">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        void <span class="token operator">*</span>arg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> calls<span class="token punctuation">[</span>NPENDINGCALLS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> first<span class="token punctuation">;</span>
    <span class="token builtin">int</span> last<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>由上，我们完成了信号从<code>初始化</code>、<code>默认加载</code>、<code>自定义函数配置</code>、<code>解释器循环执行</code>整个流程</p> <h2 id="总结一下"><a href="#总结一下" class="header-anchor">#</a> 总结一下</h2> <ul><li>当接收到信号时会保存当前上下文，然后调用注册的信号处理函数<code>trip_signal</code>。此时通过设置<code>Handlers</code>数组中对应信号的标志位来标记信号被触发，并且通过<code>make_pending_calls()</code>更改解释器的状态变量。解释器在执行下一条<code>opcode</code>时会检测状态变量，遍历<code>Handlers</code>执行所有已触发信号的处理函数。</li> <li>Python信号处理程序总是在主Python线程中执行，即使信号是在另一个线程中接收的。此外，只有主线程被允许设置一个新的信号处理器。</li> <li>如果发送多次信号可能只会调用一次信号处理函数</li></ul> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li>[1] https://docs.python.org/zh-cn/3.9/library/signal.html?highlight=signal#</li> <li>[2] https://towardsdatascience.com/signals-in-linux-b34cea8c5791</li> <li>[3] https://www.kernel.org/doc/html/latest/filesystems/proc.html</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/liyaodev/lisanshiyi/edit/master/docs/md/language/python/2021-03-30-base-signal-2.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2023/1/4</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/md/language/python/2021-03-02-plugin-technology.html">
          插件技术基础学习
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">Signal信号量源码解析</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/language/python/2021-03-30-base-signal-2.html#signals简介" class="toc-sidebar-link">Signals简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#linux信号" class="toc-sidebar-link">Linux信号</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#信号流转图" class="toc-sidebar-link">信号流转图</a></li><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#信号位表示" class="toc-sidebar-link">信号位表示</a></li></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#python信号处理机制" class="toc-sidebar-link">Python信号处理机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#代码架构" class="toc-sidebar-link">代码架构</a></li><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#源码解析" class="toc-sidebar-link">源码解析</a></li></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#总结一下" class="toc-sidebar-link">总结一下</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#参考文献" class="toc-sidebar-link">参考文献</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">Signal信号量源码解析</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/language/python/2021-03-30-base-signal-2.html#signals简介" class="toc-sidebar-link">Signals简介</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#linux信号" class="toc-sidebar-link">Linux信号</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#信号流转图" class="toc-sidebar-link">信号流转图</a></li><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#信号位表示" class="toc-sidebar-link">信号位表示</a></li></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#python信号处理机制" class="toc-sidebar-link">Python信号处理机制</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#代码架构" class="toc-sidebar-link">代码架构</a></li><li class="toc-sidebar-sub-header"><a href="/md/language/python/2021-03-30-base-signal-2.html#源码解析" class="toc-sidebar-link">源码解析</a></li></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#总结一下" class="toc-sidebar-link">总结一下</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/language/python/2021-03-30-base-signal-2.html#参考文献" class="toc-sidebar-link">参考文献</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/wechat.png" class="nozoom"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.9rem">微信扫一扫</span> <img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://lisanshiyi.com/md/language/python/2021-03-30-base-signal-2.html" style="margin:10px;">
              支持<b>手机看</b>或分享至<b>朋友圈</b></div></div></div></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div class="option-box"><img src="/images/system/heart-1.png" width="25px" class="nozoom"> <span class="show-txt">赞赏我</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="text-align:center"><span style="font-size:0.8rem;font-weight:bold;">鼓励/支持/赞赏我</span> <img height="180px" src="/images/personal/likecode.jpeg" style="margin:5px;"></div></div></div></div> <!----> <div title="插件技术基础学习" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/language/python/2021-03-02-plugin-technology.html"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <div class="page-side-sitemap"><div class="option-box"><img src="/images/system/sitemap.png" class="nozoom img"> <span class="show-txt">站点图</span> <div class="sitemap-container"><h4>站点导航图
            <a href="/md/about/me/platform/default.html" class="sitemap-top-link"> 关于我</a> <a href="/md/about/platform/default.html" class="sitemap-top-link"> 关于平台</a></h4> <table class="sitemap-table"><tr><td nowrap="nowrap"><div class="sitemap-col-group">常用搜索</div></td> <td><div class="sitemap-col-item"><a href="http://www.baidu.com/" target="_blank" title="百度">  
          百度
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.google.com/" target="_blank" title="Google">  
          Google
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.bing.com/" target="_blank" title="Bing">  
          Bing
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://github.com" target="_blank" title="Github">  
          Github
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://gitee.com" target="_blank" title="Gitee">  
          Gitee
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.programcreek.com/java-api-examples/index.php" target="_blank" title="搜代码">  
          搜代码
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">技术社区</div></td> <td><div class="sitemap-col-item"><a href="http://www.csdn.net/" target="_blank" title="CDSN">  
          CDSN
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="http://www.cnblogs.com/" target="_blank" title="博客园">  
          博客园
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.oschina.net" target="_blank" title="OSChina">  
          OSChina
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://segmentfault.com/" target="_blank" title="思否">  
          思否
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://juejin.im" target="_blank" title="掘金">  
          掘金
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.linuxidc.com/" target="_blank" title="Linux公社">  
          Linux公社
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://www.ibm.com/developerworks/cn/" target="_blank" title="IBM 开发者">  
          IBM 开发者
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="sitemap-col-item"><a href="https://stackoverflow.com" target="_blank" title="StackOverflow">  
          StackOverflow
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr><tr><td nowrap="nowrap"><div class="sitemap-col-group">知识星球</div></td> <td><div class="sitemap-col-item"><a href="https://t.zsxq.com/05IMnEQFY" target="_blank" title="编程清单">  
          编程清单
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></td> <!----></tr></table></div></div></div> <!----> </aside></div><div class="global-ui"><div class="read-more-wrap" style="display:none;position:absolute;bottom:0px;z-index:9999;width:100%;margin-top:-100px;font-family:PingFangSC-Regular, sans-serif;"><div id="read-more-mask" style="position: relative; height: 200px; background: -webkit-gradient(linear, 0 0%, 0 100%, from(rgba(255, 255, 255, 0)), to(rgb(255, 255, 255)));"></div> <a id="read-more-btn" target="_self" style="position: absolute; left: 50%; top: 70%; bottom: 30px; transform: translate(-50%, -50%); width: 160px; height: 36px; line-height: 36px; font-size: 15px; text-align: center; border: 1px solid rgb(222, 104, 109); color: rgb(222, 104, 109); background: rgb(255, 255, 255); cursor: pointer; border-radius: 6px;">阅读全文</a> <div id="btw-modal-wrap" style="display: none;"><div id="btw-mask" style="position: fixed; top: 0px; right: 0px; bottom: 0px; left: 0px; opacity: 0.7; z-index: 999; background: rgb(0, 0, 0);"></div> <div id="btw-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; text-align: center; font-size: 13px; background: rgb(255, 255, 255); border-radius: 10px; z-index: 9999; font-family: PingFangSC-Regular, sans-serif;"><span id="btw-modal-close-btn" style="position: absolute; top: 5px; right: 15px; line-height: 34px; font-size: 34px; cursor: pointer; opacity: 0.2; z-index: 9999; color: rgb(0, 0, 0); background: none; border: none; outline: none;">×</span> <p id="btw-modal-header" style="margin-top: 40px; line-height: 1.8; font-size: 13px;">
                扫码或搜索：<span style="color: #E9405A; font-weight: bold;">李三十一</span> <br>发送：<span id="site-token" class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span> <br>即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章</p> <img src="/images/personal/subcode.png" style="width: 180px; margin-top: 10px; margin-bottom: 30px; border: 8px solid rgb(230, 230, 230);"></div></div></div><div class="pay-read-more-wrap" style="display:none;position:absolute;bottom:0px;z-index:9999;width:100%;margin-top:-100px;font-family:PingFangSC-Regular, sans-serif;"><div id="pay-read-more-mask" style="position: relative; height: 200px; background: -webkit-gradient(linear, 0 0%, 0 100%, from(rgba(255, 255, 255, 0)), to(rgb(255, 255, 255)));"></div> <a id="pay-read-more-btn" target="_blank" style="position: absolute; left: 50%; top: 70%; bottom: 30px; transform: translate(-50%, -50%); width: 160px; height: 36px; line-height: 36px; font-size: 15px; text-align: center; border: 1px solid rgb(222, 104, 109); color: rgb(222, 104, 109); background: rgb(255, 255, 255); cursor: pointer; border-radius: 6px;">付费阅读</a></div></div></div>
    <script src="/assets/js/cg-styles.js?v=1672838731017" defer></script><script src="/assets/js/cg-3.js?v=1672838731017" defer></script><script src="/assets/js/cg-4.js?v=1672838731017" defer></script><script src="/assets/js/cg-43.js?v=1672838731017" defer></script><script src="/assets/js/cg-5.js?v=1672838731017" defer></script><script src="/assets/js/cg-6.js?v=1672838731017" defer></script><script src="/assets/js/cg-app.js?v=1672838731017" defer></script>
  </body>
</html>
