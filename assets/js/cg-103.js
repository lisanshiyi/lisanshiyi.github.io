(window.webpackJsonp=window.webpackJsonp||[]).push([[103],{395:function(s,t,n){"use strict";n.r(t);var e=n(7),a=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("结合上一篇文章"),t("a",{attrs:{href:"https://lisanshiyi.com/md/sourcecode/urllib3/2022-02-28-source-code-timeout.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("《urllib3超时模块源码解析》"),t("OutboundLink")],1),s._v("，我们学习了 "),t("a",{attrs:{href:"https://github.com/urllib3/urllib3",target:"_blank",rel:"noopener noreferrer"}},[s._v("urllib3"),t("OutboundLink")],1),s._v(" 的基本语法、常见姿势和请求管理模式，以及"),t("code",[s._v("PoolManager")]),s._v("、"),t("code",[s._v("HTTPConnectionPool")]),s._v("、"),t("code",[s._v("HTTPConnection")]),s._v("等模块部分源码。对于学习 Python 的小伙伴来说，urllib3 强大的功能几乎能实现所有 HTTP 请求场景，但这就足够了吗？")]),s._v(" "),t("p",[s._v("接下来我们做个验证，通过 POST 发送请求并将请求结果转 JSON 存储的小例子，如下：")]),s._v(" "),t("p",[t("strong",[s._v("urllib3发送POST请求")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" json\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" urllib3\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1 创建连接")]),s._v("\n  http "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" urllib3.PoolManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2 编码参数")]),s._v("\n  from urllib.parse "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" urlencode\n  encoded_args "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" urlencode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'arg'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'value'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3 请求")]),s._v("\n  url "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://httpbin.org/post?'")]),s._v(" + encoded_args\n  r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" http.request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'POST'")]),s._v(", url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4 解码结果")]),s._v("\n  decode_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" r.data.decode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'utf-8'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 5 转JSON")]),s._v("\n  data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" json.loads"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("decode_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'args'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  print"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'arg'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'value'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("发送一个 "),t("a",{attrs:{href:"https://urllib3.readthedocs.io/en/stable/user-guide.html#query-parameters",target:"_blank",rel:"noopener noreferrer"}},[s._v("POST"),t("OutboundLink")],1),s._v(" 请求，我们总共经历了"),t("strong",[s._v("五个步骤")]),s._v("，是不是有些太麻烦了😂")]),s._v(" "),t("p",[s._v("本着程序员的极简原则，能用轮子解决的问题为啥还非得自己手撸代码，我们看看 requests 都如何操作的，如下：")]),s._v(" "),t("p",[t("strong",[s._v("requests发送POST请求")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" requests\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1 发送请求")]),s._v("\n  r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requests.post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://httpbin.org/post'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'key'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'value'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2 获取结果")]),s._v("\n  data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" r.json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  print"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'form'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'key'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'value'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("可见，通过 requests 发送 "),t("a",{attrs:{href:"https://docs.python-requests.org/en/latest/user/quickstart/#more-complicated-post-requests",target:"_blank",rel:"noopener noreferrer"}},[s._v("POST"),t("OutboundLink")],1),s._v(" 请求，只需要简单的两个步骤即可，"),t("code",[s._v("请求-接收")]),s._v("模式也更加符合我们日常语言的交流习惯，这也许就是 requests 成为当今下载量最大的 Python 包之一的原因吧！")]),s._v(" "),t("blockquote",[t("p",[s._v("Requests is one of the most downloaded Python packages today, pulling in around 30M downloads / week— according to GitHub, Requests is currently depended upon by 1,000,000+ repositories. You may certainly put your trust in this code.")]),s._v(" "),t("p",[s._v("https://github.com/psf/requests#requests")])]),s._v(" "),t("p",[s._v("接下来这篇文章，包含了对"),t("code",[s._v("requests")]),s._v("的基础应用、超时机制、请求流程的学习，辅以流程图和部分源码的分析帮助理解。篇幅较短，预计阅读时间 15 分钟，如果对您有帮助，还望不吝评价，"),t("code",[s._v("求点赞、求评论、求转发")]),s._v("。")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://img.soogif.com/V812qwMhcyPhB0GIMGkE3CrhfCoL5Ddk.gif?scope=mdnice",loading:"lazy"}})]),s._v(" "),t("p",[s._v("开始之前，我们先简单聊聊 "),t("code",[s._v("urllib")]),s._v("、"),t("code",[s._v("urllib2")]),s._v("、"),t("code",[s._v("urllib3")]),s._v("和"),t("code",[s._v("requests")]),s._v("的区别。")]),s._v(" "),t("ul",[t("li",[s._v("urllib 和 urllib2 都是 Python 代码模块，用作 URL 请求相关的工作，提供不同的功能\n"),t("ul",[t("li",[s._v("urllib2 可以接受一个 Request 对象来设置 URL 请求头，urllib 只接受一个 URL")]),s._v(" "),t("li",[s._v("urllib 提供了 urlencode/unquote 方法，用于生成 GET 查询字符串，urllib2 没有类似功能，所以 urllib 和 urllib2 "),t("strong",[s._v("经常一起使用")]),s._v("的原因")])])]),s._v(" "),t("li",[s._v("urllib3 是一个第三方 URL 库，提供了许多 Python 标准库中缺少的关键特性：线程安全、连接池、SSL/TLS验证、重试请求和HTTP重定向等等")]),s._v(" "),t("li",[s._v("requests 封装了urllib3\n"),t("ul",[t("li",[s._v("使之更简洁易用。")])])])]),s._v(" "),t("p",[t("code",[s._v("requests")]),s._v("的设计初衷就是基于简单，下面引用作者的一段话："),t("strong",[s._v("为人类而建")]),s._v("，可见作者的良苦用心。当然，本篇文章也是为各位大佬而写，记得给号主点个赞👍啊～！")]),s._v(" "),t("blockquote",[t("p",[s._v("A simple, yet elegant, HTTP library.\nRequests is an elegant and simple HTTP library for Python, "),t("a",{attrs:{href:"https://docs.python-requests.org/en/latest/#requests-http-for-humans",target:"_blank",rel:"noopener noreferrer"}},[s._v("built for human beings"),t("OutboundLink")],1),s._v(".")])]),s._v(" "),t("img",{attrs:{src:"https://lisanshiyi.com/assets/sourcecode/requests/requests-01.png",width:"250px",height:"250px"}}),s._v(" "),t("h2",{attrs:{id:"requests-常用的两种姿势"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#requests-常用的两种姿势"}},[s._v("#")]),s._v(" requests 常用的两种姿势")]),s._v(" "),t("p",[t("strong",[s._v("一、直接使用")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" requests\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requests.get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://api.github.com/events'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.status_code\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.headers"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'content-type'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'application/json; charset=utf-8'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.encoding\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'utf-8'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.text\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'[{"id":"20714286674","type":"PushEven... \'')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20714286674'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'type'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PushEvent'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[t("strong",[s._v("二、通过 Session 使用")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" requests\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" s "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requests.Session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" s.get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://api.github.com/events"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.status_code\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.headers"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'content-type'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'application/json; charset=utf-8'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.encoding\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'utf-8'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.text\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'[{"id":"20714286674","type":"PushEven... \'')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" r.json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'20714286674'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'type'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'PushEvent'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("第一种属于基本使用，满足日常大部分请求场景，第二种"),t("code",[s._v("requests.Session")]),s._v("对象允许跨请求持久化某些参数、持久化 Cookie 和使用 urllib3 的连接池。因此，在向同一主机发送多个请求的场景，底层 TCP 连接将被重用，这可能显著提升请求性能。")]),s._v(" "),t("h2",{attrs:{id:"requests-架构其实很简单"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#requests-架构其实很简单"}},[s._v("#")]),s._v(" requests 架构其实很简单")]),s._v(" "),t("p",[s._v("整个架构包括两部分："),t("code",[s._v("Session")]),s._v("持久化参数和"),t("code",[s._v("HTTPAdapter")]),s._v("适配器连接请求，其余部分都是 "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzIwODYxMDc2NA==&mid=2247483975&idx=1&sn=65786889178c446ffc74ebaa68e338af&chksm=970136e4a076bff21b72ff254e810497b2d5fc6e756f731e1c9480e2662fc554526bb60e846a&token=1926087258&lang=zh_CN#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("urllib3"),t("OutboundLink")],1),s._v(" 的内容。")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/sourcecode/requests/requests-02.png",loading:"lazy"}})]),s._v(" "),t("p",[s._v("读到这里，号主分享的内容基本就结束了，后续的部分涉及源码，如果没兴趣可以直接跳到文章末尾。")]),s._v(" "),t("h2",{attrs:{id:"requests-源码不过如此"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#requests-源码不过如此"}},[s._v("#")]),s._v(" requests 源码不过如此")]),s._v(" "),t("blockquote",[t("p",[s._v("源码版本：v2.26.0 "),t("br"),s._v("\n源码路径：https://github.com/psf/requests/tree/v2.26.0")])]),s._v(" "),t("p",[t("code",[s._v("requests")]),s._v("包除了常见的"),t("code",[s._v("GET")]),s._v("、"),t("code",[s._v("POST")]),s._v("、"),t("code",[s._v("DELETE")]),s._v("、"),t("code",[s._v("PUT")]),s._v("之外，还有"),t("code",[s._v("timeout")]),s._v("参数功能也非常好用，可以防止请求阻塞太长时间，具体如下：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" requests\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" requests.get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://api.github.com/events"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Response "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" requests.get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://api.github.com/events"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nTraceback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("most recent call last"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/urllib3/connection.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("141")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" _new_conn\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self.host, self.port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", self.timeout, **extra_kw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/urllib3/util/connection.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" create_connection\n    sock.connect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nsocket.timeout: timed out\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("most recent call last"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/urllib3/connectionpool.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("601")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" urlopen\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("chunked")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("chunked"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/urllib3/connection.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("146")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" _new_conn\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self.host, self.timeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\nurllib3.exceptions.ConnectTimeoutError: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("urllib3.connection.VerifiedHTTPSConnection object at 0x7f98ba78e11"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Connection to api.github.com timed out. (connect timeout=1e-05)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("most recent call last"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/requests/adapters.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("440")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" send\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("timeout\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/urllib3/util/retry.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("388")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" increment\n    raise MaxRetryError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("_pool, url, error or ResponseError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cause"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\nurllib3.exceptions.MaxRetryError: HTTPSConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'api.github.com'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Max retries exceeded with url: /events "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Caused by ConnectTimeoutError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("urllib3.connection.VerifiedHTTPSConnection object at 0x7f98ba78e11"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Connection to api.github.com timed out. (connect timeout=1e-05)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("most recent call last"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<stdin>"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("module"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/requests/api.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("72")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" get\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'get'")]),s._v(", url, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("params")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("params, **kwargs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/requests/api.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" request\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" session.request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("method"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("method, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("url")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("url, **kwargs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/anaconda3/envs/python37/lib/python3.7/site-packages/requests/adapters.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("496")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" send\n    raise ConnectTimeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("request")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nrequests.exceptions.ConnectTimeout: HTTPSConnectionPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'api.github.com'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Max retries exceeded with url: /events "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Caused by ConnectTimeoutError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("urllib3.connection.VerifiedHTTPSConnection object at 0x7f98ba78e11"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v(">")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Connection to api.github.com timed out. (connect timeout=1e-05)'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br")])]),t("p",[s._v("由上，我们逆序追踪超时报错流程为："),t("br"),s._v("-> "),t("code",[s._v("requests/adapters.py(ConnectTimeoutError(<urllib3.connection.HTTPConnection)")]),s._v(" "),t("br"),s._v("-> "),t("code",[s._v("urllib3.util/retry.py(ConnectTimeoutError)")]),s._v(" "),t("br"),s._v("-> "),t("code",[s._v("urllib3/connection.py(ConnectTimeoutError)")]),s._v(" "),t("br"),s._v("-> "),t("code",[s._v("urllib3/util/connection.py(socket.timeout: timed out)")])]),s._v(" "),t("p",[s._v("接下来，我们逆序追踪超时异常流程代码，由于"),t("code",[s._v("requests")]),s._v("包发出的"),t("code",[s._v("HTTP")]),s._v("请求是基于"),t("code",[s._v("urllib3")]),s._v("包进行开发，"),t("code",[s._v("Timeout")]),s._v("机制也是直接沿用"),t("code",[s._v("urllib3")]),s._v("的超时逻辑进行处理，如下：")]),s._v(" "),t("div",{staticClass:"language-python3 line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# 入口 \n# https://github.com/psf/requests/blob/v2.26.0/requests/api.py#L16\n\ndef request(method, url, **kwargs):\n    """Constructs and sends a :class:`Request <Request>`.\n\n    :param method: method for the new :class:`Request` object: ``GET``, ``OPTIONS``, ``HEAD``, ``POST``, ``PUT``, ``PATCH``, or ``DELETE``.\n    :param url: URL for the new :class:`Request` object.\n    :param params: (optional) Dictionary, list of tuples or bytes to send\n        in the query string for the :class:`Request`.\n    \n    with sessions.Session() as session:\n        return session.request(method=method, url=url, **kwargs)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("请求被发送至"),t("code",[s._v("session.request")])]),s._v(" "),t("div",{staticClass:"language-python3 line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# https://github.com/psf/requests/blob/v2.26.0/requests/sessions.py#L470\n\ndef request(self, method, url,\n        params=None, data=None, headers=None, cookies=None, files=None,\n        auth=None, timeout=None, allow_redirects=True, proxies=None,\n        hooks=None, stream=None, verify=None, cert=None, json=None):\n    """Constructs a :class:`Request <Request>`, prepares it and sends it.\n    Returns :class:`Response <Response>` object.\n\n    :param method: method for the new :class:`Request` object.\n    :param url: URL for the new :class:`Request` object.\n    :param params: (optional) Dictionary or bytes to be sent in the query\n        string for the :class:`Request`.\n    ...\n    :param timeout: (optional) How long to wait for the server to send\n        data before giving up, as a float, or a :ref:`(connect timeout,\n        read timeout) <timeouts>` tuple.\n    :type timeout: float or tuple\n    ...\n    :rtype: requests.Response\n    """\n    # Create the Request.\n    req = Request(\n        method=method.upper(),\n        url=url,\n        headers=headers,\n        files=files,\n        data=data or {},\n        json=json,\n        params=params or {},\n        auth=auth,\n        cookies=cookies,\n        hooks=hooks,\n    )\n    prep = self.prepare_request(req)\n\n    proxies = proxies or {}\n\n    settings = self.merge_environment_settings(\n        prep.url, proxies, stream, verify, cert\n    )\n\n    # Send the request.\n    send_kwargs = {\n        \'timeout\': timeout,\n        \'allow_redirects\': allow_redirects,\n    }\n    send_kwargs.update(settings)\n    resp = self.send(prep, **send_kwargs)\n\n    return resp\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br")])]),t("p",[s._v("从架构图可知，"),t("code",[s._v("request")]),s._v("请求通过调用"),t("code",[s._v("HTTPAdapter.send")]),s._v("请求处理，具体如下")]),s._v(" "),t("div",{staticClass:"language-python3 line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# https://github.com/psf/requests/blob/v2.26.0/requests/adapters.py#L394\n\ndef send(self, request, stream=False, timeout=None, verify=True, cert=None, proxies=None):\n    """Sends PreparedRequest object. Returns Response object.\n\n    :param request: The :class:`PreparedRequest <PreparedRequest>` being sent.\n    :param stream: (optional) Whether to stream the request content.\n    :param timeout: (optional) How long to wait for the server to send\n        data before giving up, as a float, or a :ref:`(connect timeout,\n        read timeout) <timeouts>` tuple.\n    :type timeout: float or tuple or urllib3 Timeout object\n    ...\n    :rtype: requests.Response\n    """\n\n    try:\n        conn = self.get_connection(request.url, proxies)\n    except LocationValueError as e:\n        raise InvalidURL(e, request=request)\n    ...\n    # 超时配置包括 tuple 和 float 两种方式\n    if isinstance(timeout, tuple):\n        try:\n            connect, read = timeout\n            timeout = TimeoutSauce(connect=connect, read=read)\n        except ValueError as e:\n            # this may raise a string formatting error.\n            err = ("Invalid timeout {}. Pass a (connect, read) "\n                    "timeout tuple, or a single float to set "\n                    "both timeouts to the same value".format(timeout))\n            raise ValueError(err)\n    elif isinstance(timeout, TimeoutSauce):\n        pass\n    else:\n        timeout = TimeoutSauce(connect=timeout, read=timeout)\n\n    try:\n        if not chunked:\n            resp = conn.urlopen(\n                method=request.method,\n                url=url,\n                body=request.body,\n                headers=request.headers,\n                redirect=False,\n                assert_same_host=False,\n                preload_content=False,\n                decode_content=False,\n                retries=self.max_retries,\n                timeout=timeout\n            )\n\n        # Send the request.\n        else:\n            ...\n\n    except (ProtocolError, socket.error) as err:\n        raise ConnectionError(err, request=request)\n\n    except MaxRetryError as e:\n        if isinstance(e.reason, ConnectTimeoutError):\n            # TODO: Remove this in 3.0.0: see #2811\n            if not isinstance(e.reason, NewConnectionError):\n                raise ConnectTimeout(e, request=request)\n        ...\n        raise ConnectionError(e, request=request)\n    ...\n    except (_SSLError, _HTTPError) as e:\n        if isinstance(e, _SSLError):\n            # This branch is for urllib3 versions earlier than v1.22\n            raise SSLError(e, request=request)\n        elif isinstance(e, ReadTimeoutError):\n            raise ReadTimeout(e, request=request)\n        elif isinstance(e, _InvalidHeader):\n            raise InvalidHeader(e, request=request)\n        else:\n            raise\n    return self.build_response(request, resp)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br")])]),t("h2",{attrs:{id:"总结一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结一下"}},[s._v("#")]),s._v(" 总结一下")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/sourcecode/requests/requests-03.png",loading:"lazy"}}),s._v(" "),t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/sourcecode/requests/requests-04.png",loading:"lazy"}}),s._v(" "),t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/sourcecode/requests/requests-05.png",loading:"lazy"}})]),s._v(" "),t("p",[s._v("通过对比"),t("code",[s._v("Python")]),s._v("、"),t("code",[s._v("urllib3")]),s._v("、"),t("code",[s._v("requests")]),s._v("三个开源项目的"),t("code",[s._v("Sponsor")]),s._v("、"),t("code",[s._v("Watch")]),s._v("、"),t("code",[s._v("Fork")]),s._v("、"),t("code",[s._v("Star")]),s._v("指标，requests 的 stars 竟然比 python 还多3.7k？")]),s._v(" "),t("p",[s._v("一个好的成功的开源项目要么技术壁垒足够强大，如果设计足够巧妙，即使技术没那么复杂也能弯道超车。")]),s._v(" "),t("h2",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[s._v("#")]),s._v(" 参考文档")]),s._v(" "),t("ul",[t("li",[s._v("https://github.com/urllib3/urllib3")]),s._v(" "),t("li",[s._v("https://urllib3.readthedocs.io/en/stable/index.html")]),s._v(" "),t("li",[s._v("https://github.com/psf/requests")]),s._v(" "),t("li",[s._v("https://docs.python-requests.org/en/latest/user/quickstart/")])])])}),[],!1,null,null,null);t.default=a.exports}}]);