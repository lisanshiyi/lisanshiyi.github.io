(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{401:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"上下文"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#上下文"}},[s._v("#")]),s._v(" 上下文")]),s._v(" "),t("p",[s._v("传统 Python 单机系统部署中，由于 GIL 的存在，相同进程中我们可以不用处理并发问题。但是随着业务发展需要，原有单机系统演变成分布式或多进程系统后。这将使原有的单机单进程并发控制策略失效。为了解决该问题需要引入一种跨进程、跨机器的互斥锁机制来控制共享资源的访问，这也就是分布式锁的由来。")]),s._v(" "),t("p",[s._v("所以，分布式锁的引入是为了保障多台机器或多个进程对共享资源读写的同步，保证数据的最终一致性。")]),s._v(" "),t("p",[s._v("分布式锁天生具有如下特点：")]),s._v(" "),t("ul",[t("li",[s._v("互斥性：任何时刻，只允许单客户端（单进程、单节点）能持有锁。")]),s._v(" "),t("li",[s._v("安全性：能有效避免死锁情况，即使客户端持有锁机器发生崩溃或退出故障，也需要保障锁能被正确释放。")]),s._v(" "),t("li",[s._v("可用性：具备高可用能力，锁服务节点故障（即使宕机）也不应影响服务的正常运行。")]),s._v(" "),t("li",[s._v("可重入性：针对同一个锁，加锁和解锁必须为同一个进程，即对称性。")])]),s._v(" "),t("p",[s._v("常见分布式锁实现方式：")]),s._v(" "),t("ul",[t("li",[s._v("数据库：采用乐观锁、悲观锁或主键 ID 实现。")]),s._v(" "),t("li",[s._v("缓存：采用 Redis 或 RedLock (Redis组件) 实现。")]),s._v(" "),t("li",[s._v("一致性算法：采用 Zookeeper、Chubby 或 Etcd 实现。")])]),s._v(" "),t("p",[s._v("以上，号主知道的常见实现大致就这些了。接下来的篇幅主要讲解如何使用 Etcd 实现分布式锁业务，我们往下看。")]),s._v(" "),t("h2",{attrs:{id:"基于-etcd-的分布式锁实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于-etcd-的分布式锁实现"}},[s._v("#")]),s._v(" 基于 ETCD 的分布式锁实现")]),s._v(" "),t("h3",{attrs:{id:"环境安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境安装"}},[s._v("#")]),s._v(" 环境安装")]),s._v(" "),t("p",[s._v("为了保证锁服务"),t("code",[s._v("可用性")]),s._v("，我们搭建一个包含三个 Etcd 节点的 docker 集群环境，此处通过"),t("code",[s._v("docker-compose")]),s._v("进行实验配置。熟悉部署安装的号友，可跳过此部分。")]),s._v(" "),t("p",[t("strong",[s._v("步骤一：镜像拉取")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull bitnami/etcd:3.5.2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("strong",[s._v("步骤二：编辑docker-compose.yml")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("version: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3.5'")]),s._v("\n\nservices:\n  etcd1:\n    container_name: builder-etcd1\n    image: bitnami/etcd:3.5.2\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12379")]),s._v(":2379\n    environment:\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALLOW_NONE_AUTHENTICATION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_MODE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("revision\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_RETENTION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_QUOTA_BACKEND_BYTES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4294967296")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_NAME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd1\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd1:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_ADVERTISE_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd1:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd-cluster\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd1:2380,etcd2"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd2:2380,etcd3"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd3:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_STATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("new\n    volumes:\n      - "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DOCKER_ROOT_DIR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":-")]),s._v(".}")]),s._v("/volumes/etcd/data1:/bitnami/etcd\n\n  etcd2:\n    container_name: builder-etcd2\n    image: bitnami/etcd:3.5.2\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22379")]),s._v(":2379\n    environment:\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALLOW_NONE_AUTHENTICATION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_MODE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("revision\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_RETENTION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_QUOTA_BACKEND_BYTES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4294967296")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_NAME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd2\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd2:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_ADVERTISE_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd2:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd-cluster\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd1:2380,etcd2"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd2:2380,etcd3"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd3:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_STATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("new\n    volumes:\n      - "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DOCKER_ROOT_DIR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":-")]),s._v(".}")]),s._v("/volumes/etcd/data2:/bitnami/etcd\n\n  etcd3:\n    container_name: builder-etcd3\n    image: bitnami/etcd:3.5.2\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32379")]),s._v(":2379\n    environment:\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALLOW_NONE_AUTHENTICATION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_MODE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("revision\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_AUTO_COMPACTION_RETENTION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_QUOTA_BACKEND_BYTES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4294967296")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_NAME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd3\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd3:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_PEER_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_ADVERTISE_CLIENT_URLS")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd3:2379\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd-cluster\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd1:2380,etcd2"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd2:2380,etcd3"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://etcd3:2380\n      - "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_STATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("new\n    volumes:\n      - "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DOCKER_ROOT_DIR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":-")]),s._v(".}")]),s._v("/volumes/etcd/data3:/bitnami/etcd\n\nnetworks:\n  default:\n    name: builder_dev\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br")])]),t("p",[s._v("部署配置文件 docker-compose.yml 下载，详见 "),t("code",[s._v("[1]")])]),s._v(" "),t("p",[t("strong",[s._v("步骤三：启动服务")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" docker-compose.yml up\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("strong",[s._v("步骤四：验证集群")])]),s._v(" "),t("p",[s._v("验证集群节点的版本")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd1 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd --version"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd2 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd --version"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd3 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd --version"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\netcd Version: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.5")]),s._v(".2\nGit SHA: 99018a77b\nGo Version: go1.16.3\nGo OS/Arch: linux/amd64\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("验证三个节点返回的数据一致")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd1 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl put greeting '),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("hello, etcd"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# OK")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd1 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl get greeting"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd2 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl get greeting"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd3 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl get greeting"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出")]),s._v("\ngreeting\nhello, etcd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"锁的实现基础机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁的实现基础机制"}},[s._v("#")]),s._v(" 锁的实现基础机制")]),s._v(" "),t("p",[s._v("此处为 Etcd 核心机制，下文讲解的分布式锁就是基于这些基础功能和基础特性实现。")]),s._v(" "),t("p",[t("strong",[s._v("Lease 机制")]),s._v("：即租约机制（TTL），Etcd 可以为存储的 kv 对设置租约，当租约到期，kv 将失效删除；当然也支持 refresh 续约。")]),s._v(" "),t("p",[t("strong",[s._v("Revision 机制")]),s._v("：存储的每个 key 带有一个 Revision 属性值，Etcd 每进行一次事务操作，对应的全局 Revision 值都会加一，因此每个 key 对应的 Revision 属性值都是全局唯一的。通过比较 Revision 的大小就能知道写操作的顺序。")]),s._v(" "),t("p",[t("strong",[s._v("公平锁机制")]),s._v("：多个程序同时抢锁时，会根据 Revision 值大小依次获得锁，可以有效避免 “惊群效应”，公平获取。")]),s._v(" "),t("p",[t("strong",[s._v("Prefix 机制")]),s._v("：即前缀机制，可以根据前缀获取该目录下所有的 key 及对应的属性（包括 key, value 以及 revision 等）。")]),s._v(" "),t("p",[t("strong",[s._v("Watch 机制")]),s._v("：即监听机制，Watch 机制支持 Watch 某个固定的 key，也支持 Watch 一个目录（前缀机制），当被 Watch 的 key 或目录发生变化，客户端将收到通知（🐮🐮🐮）。")]),s._v(" "),t("h3",{attrs:{id:"锁的实现逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁的实现逻辑"}},[s._v("#")]),s._v(" 锁的实现逻辑")]),s._v(" "),t("p",[s._v("在 Etcd 的 clientv3 包中，官方实现了分布式锁，为了了解它的工作机制和实现逻辑，我们先做一个简单的"),t("strong",[s._v("模拟使用")]),s._v("。")]),s._v(" "),t("p",[s._v("下面我们通过"),t("code",[s._v("etcdctl")]),s._v("进行锁模拟。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终端 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd1 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl lock /lock/kv/uuid_a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /lock/kv/uuid_a/12f78036a2766634")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终端 2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd2 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl lock /lock/kv/uuid_a"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终端 3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" builder-etcd3 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl lock /lock/kv/uuid_a"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终端 1 结束，显示终端 2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /lock/kv/uuid_a/41ce8036a27a471d")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 终端 2 结束，显示终端 3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /lock/kv/uuid_a/58538036a276e81f")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("由上，三个不同节点同时对"),t("code",[s._v("/lock/kv/uuid_a")]),s._v("进行加锁，但是却被依次获得锁（简单演示，看看就行！）。")]),s._v(" "),t("p",[s._v("通过解析源码，发现 Etcd 分布式锁的实现主要集中在 "),t("code",[s._v("go.etcd.io/etcd/client/v3/concurrency")]),s._v(" 包中，通过以下三个方法进行提供：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewMutex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pfx "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Mutex        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 新建一个 Mutex 对象")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Mutex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取锁，阻塞调用")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Mutex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 释放锁")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("由上，使用 Etcd 提供分布式锁变得比预期简单许多，首先实例化一个"),t("code",[s._v("Mutex")]),s._v("对象，然后"),t("code",[s._v("Lock")]),s._v("尝试抢占锁，之后进行业务处理，最后"),t("code",[s._v("Unlock")]),s._v("释放锁即可。")]),s._v(" "),t("p",[s._v("我们先看看"),t("code",[s._v("Lock")]),s._v("函数的实现原理，具体如下：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Lock locks the mutex with a cancelable context. If the context is canceled")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// while trying to acquire the lock, the mutex tries to clean its stale lock entry.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Mutex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tresp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tryAcquire")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Mutex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tryAcquire")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("TxnResponse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\ts "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s\n\tclient "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Client")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myKey "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" fmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Sprintf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%s%x"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pfx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lease")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tcmp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Compare")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("CreateRevision")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"="')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// put self in lock waiters via myKey; oldest waiter holds lock")]),s._v("\n\tput "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("OpPut")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("WithLease")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lease")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// reuse key in case this session already holds the lock")]),s._v("\n\tget "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("OpGet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myKey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// fetch current holder to complete uncontended path with only one RPC")]),s._v("\n\tgetOwner "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("OpGet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pfx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("WithFirstCreate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tresp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Txn")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("If")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Then")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("put"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" getOwner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" getOwner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Commit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myRev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" resp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Header"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Revision\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("resp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Succeeded "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myRev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" resp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Responses"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetResponseRange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Kvs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CreateRevision\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" resp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("首先通过一个事务来尝试加锁，事务围绕着由 "),t("code",[s._v("m.pfx")]),s._v(" 和 "),t("code",[s._v("s.Lease()")]),s._v(" 组成的 Key，包含 4 个基础操作："),t("code",[s._v("cmp")]),s._v("、"),t("code",[s._v("put")]),s._v("、"),t("code",[s._v("get")]),s._v("、"),t("code",[s._v("getOwner")]),s._v("，具体如下：")]),s._v(" "),t("ul",[t("li",[s._v("cmp：比较 Key 的 Revision 版本是否为 0，其中 0 代表该锁不存在")]),s._v(" "),t("li",[s._v("put：向 Key 中存储超时时间为 Session 默认时长的空值（加锁操作）")]),s._v(" "),t("li",[s._v("get：通过 Key 查询写入")]),s._v(" "),t("li",[s._v("getOwner：由于其他 Session 也用同样 m.pfx 加锁，且每个 LeaseID 不同。通过 m.pfx 和 WithFirstCreate()来查询，第一次肯定会 put 成功，但也只有最早使用这个 pfx 的 Session 才是持有锁的，所以这个 getOwner 是该事务的关键。")])]),s._v(" "),t("p",[s._v("整个分布式锁的实现方式，通过统一的"),t("code",[s._v("前缀 m.pfx")]),s._v("来 put，然后根据各自的"),t("code",[s._v("Revision")]),s._v("版本号来排队获取锁，避免了惊群效应，效率非常高。")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://files.mdnice.com/user/12678/4228508d-c89f-462b-bd35-87e208de3193.png",loading:"lazy"}})]),s._v(" "),t("p",[s._v("如上图所示，共有 4 个 Session 进行加锁，根据 Revision 排队规则，最终获取锁的顺序分别为："),t("code",[s._v("Session2 -> Session3 -> Session1 -> Session4")]),s._v("。")]),s._v(" "),t("p",[s._v("好了，分布式相关知识点就讲解完了，讲真"),t("code",[s._v("Watch机制")]),s._v("是我的最爱，平时项目中使用也最多。但再次看完这部分原理后，发现"),t("code",[s._v("Revision机制")]),s._v("的实现真的很巧妙，不得不佩服这帮巨佬。")]),s._v(" "),t("h3",{attrs:{id:"python-分布式锁使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#python-分布式锁使用"}},[s._v("#")]),s._v(" Python 分布式锁使用")]),s._v(" "),t("p",[s._v("接下来，使用 Etcd v3 版 SDK 进行一个简单的业务使用，查遍全网似乎只有 python-etcd3 [2] 这个小众包，号友们将就用，别吐槽。")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -*- coding: utf-8 -*-")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" etcd3\n\netcd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etcd3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'127.0.0.1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlock_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid_a"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实现 A")]),s._v("\nlock "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ttl"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("acquire"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_acquired"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取加锁状态 或 具体业务")]),s._v("\nlock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("release"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实现 B(推荐)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ttl"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_acquired"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取加锁状态 或 具体业务")]),s._v("\n    lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("refresh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("h2",{attrs:{id:"结语"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结语"}},[s._v("#")]),s._v(" 结语")]),s._v(" "),t("p",[s._v("本文从基础概念、Etcd 实现原理、Python 业务应用角度对分布式锁进行剖析学习，限于篇幅和个人水平，Go相关内容没有进行继续深入。")]),s._v(" "),t("p",[s._v("Etcd3.0 相对于 2.0 版本，官方使用 gRPC 替换 JSON，在效率、可靠性、可扩展性和易用性等方面都有了很大进步。")]),s._v(" "),t("p",[s._v("Python 对 3.0 版本支持较弱，主要体现在没有稳定的 SDK 包，且大部分包对 Python 的版本支持也仅限于 <= 3.7(😒)。")]),s._v(" "),t("h2",{attrs:{id:"参考文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文件"}},[s._v("#")]),s._v(" 参考文件")]),s._v(" "),t("ul",[t("li",[s._v("[1] https://github.com/liyaodev/docker-compose")]),s._v(" "),t("li",[s._v("[2] https://github.com/kragniz/python-etcd3/tree/master")])])])}),[],!1,null,null,null);t.default=e.exports}}]);