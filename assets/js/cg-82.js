(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{374:function(s,a,e){"use strict";e.r(a);var n=e(7),t=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("ul",[a("li",[s._v("为了让尝试“以图搜图”的相似图片检索的场景，基于ES向量索引计算和图片特征提取模型 VGG16 设计了一个以图搜图系统。")]),s._v(" "),a("li",[s._v("开源地址："),a("a",{attrs:{href:"https://github.com/liyaodev/image-retrieval",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/liyaodev/image-retrieval"),a("OutboundLink")],1)])]),s._v(" "),a("h3",{attrs:{id:"检索场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检索场景"}},[s._v("#")]),s._v(" 检索场景")]),s._v(" "),a("ul",[a("li",[s._v("推理流程：读取图片，算法生成特征向量")]),s._v(" "),a("li",[s._v("特征入库：把特征向量存入ES中")]),s._v(" "),a("li",[s._v("检索流程：线上实时向量检索")]),s._v(" "),a("li",[s._v("具体流程如下图：\n"),a("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/other/notes/image-vector-retrieval-3-1.jpg",loading:"lazy"}})])]),s._v(" "),a("h3",{attrs:{id:"es向量索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#es向量索引"}},[s._v("#")]),s._v(" ES向量索引")]),s._v(" "),a("ul",[a("li",[s._v("Dense Vector：存储稠密向量，存储为单值字段数组，数组的最大长度不能超过2048，每个文档的数组长度可以不同\n"),a("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/other/notes/image-vector-retrieval-3-2.jpg",loading:"lazy"}})]),s._v(" "),a("li",[s._v("Sparse Vector：存储稀疏向量，存储为非嵌套类型的json对象，key是向量的位置，即integer类型的字符串，范围[0,65535]，value是向量值。但7.6版本后不在支持稀疏向量，请谨慎使用\n"),a("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://lisanshiyi.com/assets/other/notes/image-vector-retrieval-3-3.jpg",loading:"lazy"}})])]),s._v(" "),a("h3",{attrs:{id:"es检索实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#es检索实现"}},[s._v("#")]),s._v(" ES检索实现")]),s._v(" "),a("ul",[a("li",[s._v("提供余弦、曼哈顿、欧式和点积四种距离方式，具体代码如下：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 余弦距离\nscript_query = {\n    "script_score": {\n        "query": {"match_all": {}},\n        "script": {\n            "source": "cosineSimilarity(params.query_vector, doc[\'image_vector\']) + 1.0",\n            "params": {"query_vector": query_vector}\n        }\n    }\n}\n# 曼哈顿距离\nscript_query = {\n    "script_score": {\n        "query": {"match_all": {}},\n        "script": {\n            "source": "1 / (1 + l1norm(params.queryVector, doc[\'image_vector\']))", \n            "params": {\n            "queryVector": query_vector\n            }\n        }\n    }\n}\n# 欧几里德距离\nscript_query = {\n    "script_score": {\n        "query": {"match_all": {}},\n        "script": {\n            "source": "1 / (1 + l2norm(params.queryVector, doc[\'image_vector\']))",\n            "params": {\n            "queryVector": query_vector\n            }\n        }\n    }\n}\n\n# DotProduct实现\nscript_query = {\n    "script_score": {\n        "query": {"match_all": {}},\n        "script": {\n            "source": """\n                double value = doc[\'image_vector\'].size() == 0 ? 0 : dotProduct(params.query_vector, doc[\'image_vector\']);\n                return value;\n                """,\n            "params": {"query_vector": query_vector}\n        }\n    }\n}\nresponse = self.client.search(\n    index=self.index_name,\n    body={\n        "size": search_size,\n        "query": script_query,\n        "_source": {"includes": ["id", "name", "face_vector"]}\n    }\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("h3",{attrs:{id:"es服务端安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#es服务端安装"}},[s._v("#")]),s._v(" ES服务端安装")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('docker run -it -d -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:7.5.0\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"操作简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#操作简介"}},[s._v("#")]),s._v(" 操作简介")]),s._v(" "),a("ul",[a("li",[s._v("下载工程源码："),a("a",{attrs:{href:"https://github.com/liyaodev/image-retrieval",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/liyaodev/image-retrieval"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("操作一：构建基础索引")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python index.py\n--train_data：自定义训练图片文件夹路径，默认为`<ROOT_DIR>/data/train`\n--index_file：自定义索引文件存储路径，默认为`<ROOT_DIR>/index/train.h5`\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("操作二：使用相似检索")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python retrieval.py --engine=es\n--test_data：自定义测试图片详细地址，默认为`<ROOT_DIR>/data/test/001_accordion_image_0001.jpg`\n--index_file：自定义索引文件存储路径，默认为`<ROOT_DIR>/index/train.h5`\n--db_name：自定义ES或者Milvus索引库名，默认为`image_retrieval`\n--engine：自定义检索引擎类型，默认为`numpy`，可选包括：numpy、faiss、es、milvus\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("ul",[a("li",[s._v("扩展 ElasticSearch 的能力使其支持向量检索")]),s._v(" "),a("li",[s._v("便于利用ElasticSearch分布式可扩展的能力")]),s._v(" "),a("li",[s._v("利用 ElasticSearch 查询函数和其他插件，便于扩展其他维度的检索")]),s._v(" "),a("li",[s._v("ES向量计算都是线性扫描，耗时和文档数量、硬件性能正相关，请验证后使用")])]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("That's all!")])])}),[],!1,null,null,null);a.default=t.exports}}]);