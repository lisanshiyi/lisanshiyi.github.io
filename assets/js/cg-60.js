(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{352:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("这篇文章，是学习"),t("code",[s._v("Protobuf")]),s._v("过程中偶然所得，算法简洁，篇幅较短，预计阅读时间 4 分钟，如果对您有帮助，还望不吝评价，"),t("code",[s._v("求点赞、求评论、求转发")]),s._v("。\n"),t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://img.soogif.com/atOJenN7c39SwKTwHOntOHbfOnXGcHt9.gif?scope=mdnice",loading:"lazy"}})]),s._v(" "),t("h3",{attrs:{id:"varint-是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#varint-是什么"}},[s._v("#")]),s._v(" Varint 是什么？")]),s._v(" "),t("p",[s._v("早期，为了更好计算效率，我们的计算机中数值通常使用定长整型"),t("code",[s._v("(fixed length intergers)")]),s._v("表示。但是，"),t("code",[s._v("微服务")]),s._v("、"),t("code",[s._v("RPC")]),s._v(" 架构盛行的今天，定长整型就显得冗余。")]),s._v(" "),t("p",[s._v("在大多数计算机系统中，以"),t("code",[s._v("4 Bytes")]),s._v("和"),t("code",[s._v("8 Bytes")]),s._v("来表示整数(Int32、Int64)。这样，为了传输一个整数"),t("code",[s._v("1")]),s._v("，我们需要传输"),t("code",[s._v("00000000 00000000 00000000 00000001")]),s._v(" 32 个 bits，而有价值的数据只有 1 位，这也太浪费了吧？")]),s._v(" "),t("p",[s._v("为了节约网络带宽，我们需要一种更加灵活的方式传输方式。"),t("code",[s._v("Varint(Variable length integers)")]),s._v("便是一种用于压缩整型数值的方法，通过它可以更加灵活的表达整型数值需要的空间大小。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("十进制：1\n二进制：00000000 00000000 00000000 00000001\nVarint：00000001\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("可以看到，通过使用"),t("code",[s._v("Varint")]),s._v("方法，我们将传输大小从"),t("code",[s._v("4 Bytes")]),s._v("压缩至"),t("code",[s._v("1 Bytes")]),s._v("，这怎么弄的呢？")]),s._v(" "),t("h3",{attrs:{id:"varint-的原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#varint-的原理"}},[s._v("#")]),s._v(" Varint 的原理")]),s._v(" "),t("p",[t("strong",[s._v("编码规则")])]),s._v(" "),t("ul",[t("li",[s._v("a.将整数的二进制按"),t("code",[s._v("7bit")]),s._v("分组，从低位到高位依次排列")]),s._v(" "),t("li",[s._v("b.最后一组"),t("code",[s._v("MSB")]),s._v("设置"),t("code",[s._v("0")]),s._v("，其他组的"),t("code",[s._v("MSB")]),s._v("设置为"),t("code",[s._v("1")])])]),s._v(" "),t("p",[t("strong",[s._v("编码演示")])]),s._v(" "),t("p",[s._v("按"),t("code",[s._v("7bit")]),s._v("进行分组，对数组逆序设置"),t("code",[s._v("MSB(Most Significant Bit)")]),s._v("即可，具体如图：")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"image2022-3-3_21-29-55","data-src":"https://lisanshiyi.com/assets/network/grpc/grpc-01.png",loading:"lazy"}})]),s._v(" "),t("p",[t("strong",[s._v("解码规则")])]),s._v(" "),t("ul",[t("li",[s._v("a.去掉"),t("code",[s._v("MSB")]),s._v("重新组合"),t("code",[s._v("7bit")]),s._v("字符列表")]),s._v(" "),t("li",[s._v("b.逆序存储"),t("code",[s._v("7bit")]),s._v("字符列表")])]),s._v(" "),t("h3",{attrs:{id:"varint-编码实现-python"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#varint-编码实现-python"}},[s._v("#")]),s._v(" Varint 编码实现(Python)")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("varint_compress")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zz"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" zz"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("append"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x7F")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            zz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" zz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("append"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x7F")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h3",{attrs:{id:"获取-varint-的长度方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取-varint-的长度方法"}},[s._v("#")]),s._v(" 获取 Varint 的长度方法")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("varint_code_len")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("vb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" vb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        vb "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n        res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"varint-解码实现-python"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#varint-解码实现-python"}},[s._v("#")]),s._v(" Varint 解码实现(Python)")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("varint_decompress")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    offset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("len")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("zb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x7F")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" offset\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" zb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" offset\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n        offset "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h3",{attrs:{id:"总结一下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结一下"}},[s._v("#")]),s._v(" 总结一下")]),s._v(" "),t("p",[s._v("在大多数情况下，通过"),t("code",[s._v("Varint")]),s._v(" 编码整数都有好压缩效果，但遇到负数或大整数，就不具备压缩优势了，如下：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("十进制：-1\n二进制：10000000 00000000 00000000 00000001\nVarint：10000001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" 00001000\n\n十进制：2^30\n二进制：01000000 00000000 00000000 00000000\nVarint：10000000 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000000")]),s._v(" 00000100\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("由于引入了"),t("code",[s._v("MSB")]),s._v("，不但没有好的压缩效果，还加大了存储，这明显不是我们想要的\n那怎么办呢？"),t("code",[s._v("ZigZag")]),s._v("由此而生，那这个算法具体思想是怎么样的呢？请听我们下回分解")]),s._v(" "),t("h3",{attrs:{id:"参考文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[s._v("#")]),s._v(" 参考文档")]),s._v(" "),t("ul",[t("li",[s._v("https://en.wikipedia.org/wiki/Variable-length_quantity")]),s._v(" "),t("li",[s._v("https://developers.google.com/protocol-buffers/docs/encoding#varints")])])])}),[],!1,null,null,null);t.default=e.exports}}]);